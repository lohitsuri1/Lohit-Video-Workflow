/**
 * generate-devotional-video.js
 *
 * Downloads royalty-free Radha-Krishna devotional images from Wikimedia Commons
 * and stitches them into a 15-minute video with Ken-Burns animation and a
 * devotional ambient audio track generated by ffmpeg.
 *
 * Folder layout (created automatically):
 *   library/assets/devotion/radha-krishna/images/  ‚Äì downloaded images
 *   library/assets/devotion/radha-krishna/music/   ‚Äì generated audio
 *   library/videos/radha-krishna-15min.mp4          ‚Äì final video
 *
 * No external API keys are required.  All image sources are public-domain
 * works from Wikimedia Commons.  Audio is synthesised locally with ffmpeg.
 *
 * Usage:
 *   node scripts/generate-devotional-video.js
 */

import fs from 'fs';
import https from 'https';
import http from 'http';
import os from 'os';
import path from 'path';
import { spawnSync } from 'child_process';

// ‚îÄ‚îÄ Configuration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const THEME = 'devotion';
const GOD_NAME = 'radha-krishna';
const BASE_ASSETS = path.join('library', 'assets', THEME, GOD_NAME);
const IMAGES_DIR = path.join(BASE_ASSETS, 'images');
const MUSIC_DIR = path.join(BASE_ASSETS, 'music');
const OUTPUT_DIR = path.join('library', 'videos');
const OUTPUT_FILE = path.join(OUTPUT_DIR, 'radha-krishna-15min.mp4');

const VIDEO_DURATION_SECS = 900; // 15 minutes
const SECONDS_PER_IMAGE = 60;    // each image is displayed for 60 seconds
const NUM_IMAGES = Math.ceil(VIDEO_DURATION_SECS / SECONDS_PER_IMAGE); // 15
const TARGET_WIDTH = 1280;
const TARGET_HEIGHT = 720;
const FPS = 25;

// Network timeouts
const SEARCH_TIMEOUT_MS = 20_000;
const INFO_TIMEOUT_MS = 15_000;
const DOWNLOAD_TIMEOUT_MS = 20_000;

// Ken-Burns animation parameters
const ZOOM_RATE = 0.0005;
const MAX_ZOOM = 1.2;

// Fallback colours used when an image cannot be downloaded (saffron palette)
const FALLBACK_COLORS = [
    '0xFF7B00', '0xFF9500', '0xFFD700', '0xB5451B',
    '0x8B0000', '0x4B0082', '0x800080', '0xFF1493',
    '0xFF6347', '0xFFAA00', '0xCC5500', '0xDC143C',
    '0xC71585', '0x9400D3', '0xFF8C00',
];

// ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/** Download a URL to destPath, following up to maxRedirects redirects. */
function downloadFile(url, destPath, maxRedirects = 8) {
    return new Promise((resolve, reject) => {
        if (maxRedirects <= 0) return reject(new Error('Too many redirects'));
        const protocol = url.startsWith('https://') ? https : http;
        const req = protocol.get(url, { timeout: DOWNLOAD_TIMEOUT_MS }, (res) => {
            if ([301, 302, 307, 308].includes(res.statusCode)) {
                const loc = res.headers.location;
                res.resume();
                downloadFile(loc, destPath, maxRedirects - 1).then(resolve).catch(reject);
                return;
            }
            if (res.statusCode !== 200) {
                res.resume();
                return reject(new Error(`HTTP ${res.statusCode} for ${url}`));
            }
            const file = fs.createWriteStream(destPath);
            res.pipe(file);
            file.on('finish', () => file.close(resolve));
            file.on('error', (err) => { fs.unlink(destPath, () => {}); reject(err); });
        });
        req.on('error', (err) => { fs.unlink(destPath, () => {}); reject(err); });
        req.on('timeout', () => { req.destroy(); reject(new Error(`Timeout downloading ${url}`)); });
    });
}

/** Run ffmpeg with the supplied argument array.  Throws on non-zero exit. */
function runFFmpeg(args) {
    const result = spawnSync('ffmpeg', args, { stdio: 'inherit' });
    if (result.status !== 0) {
        throw new Error(`ffmpeg exited with code ${result.status}. ` +
            'Ensure ffmpeg is installed (apt-get install -y ffmpeg).');
    }
}

// ‚îÄ‚îÄ Step 1: Download images from Wikimedia Commons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function downloadWikimediaImages() {
    console.log('\nüì∑  Fetching Radha-Krishna images from Wikimedia Commons‚Ä¶');

    const searchQueries = [
        'Radha Krishna painting',
        'Radha Krishna artwork Hindu',
        'Krishna flute painting',
        'Vrindavan Krishna devotional art',
    ];

    const fileNames = new Set();
    for (const query of searchQueries) {
        const apiUrl =
            'https://commons.wikimedia.org/w/api.php?action=query&list=search' +
            `&srsearch=${encodeURIComponent(query)}&srnamespace=6&srlimit=10&format=json`;
        try {
            const res = await fetch(apiUrl, { signal: AbortSignal.timeout(SEARCH_TIMEOUT_MS) });
            const data = await res.json();
            for (const item of data.query?.search ?? []) {
                if (/\.(jpe?g|png)$/i.test(item.title)) fileNames.add(item.title);
            }
        } catch (err) {
            console.warn(`  ‚ö†  Search "${query}" failed: ${err.message}`);
        }
    }

    const candidates = [...fileNames].slice(0, NUM_IMAGES + 5);
    console.log(`  Found ${candidates.length} candidate files on Wikimedia Commons`);

    const downloaded = [];
    let idx = 1;

    for (const title of candidates) {
        if (downloaded.length >= NUM_IMAGES) break;
        const infoUrl =
            'https://commons.wikimedia.org/w/api.php?action=query' +
            `&titles=${encodeURIComponent(title)}&prop=imageinfo` +
            `&iiprop=url&iiurlwidth=${TARGET_WIDTH}&format=json`;
        try {
            const res = await fetch(infoUrl, { signal: AbortSignal.timeout(INFO_TIMEOUT_MS) });
            const data = await res.json();
            const page = Object.values(data.query?.pages ?? {})[0];
            const imageUrl = page?.imageinfo?.[0]?.thumburl ?? page?.imageinfo?.[0]?.url;
            if (!imageUrl) continue;

            const ext = path.extname(new URL(imageUrl).pathname).toLowerCase() || '.jpg';
            const destPath = path.join(IMAGES_DIR, `radha-krishna-${String(idx).padStart(2, '0')}${ext}`);
            console.log(`  ‚¨á  [${idx}/${NUM_IMAGES}] ${path.basename(destPath)}`);
            await downloadFile(imageUrl, destPath);
            downloaded.push(destPath);
            idx++;
        } catch (err) {
            console.warn(`  ‚ö†  Skipping "${title}": ${err.message}`);
        }
    }

    // Fill remaining slots with ffmpeg colour placeholders if images were unavailable
    while (downloaded.length < NUM_IMAGES) {
        const color = FALLBACK_COLORS[(idx - 1) % FALLBACK_COLORS.length];
        const destPath = path.join(IMAGES_DIR, `radha-krishna-${String(idx).padStart(2, '0')}.jpg`);
        console.log(`  üé®  [${idx}/${NUM_IMAGES}] Generating colour placeholder (${color})`);
        runFFmpeg([
            '-y', '-f', 'lavfi',
            '-i', `color=c=${color}:size=${TARGET_WIDTH}x${TARGET_HEIGHT}:rate=1`,
            '-frames:v', '1', destPath,
        ]);
        downloaded.push(destPath);
        idx++;
    }

    console.log(`  ‚úÖ  ${downloaded.length} images ready in ${IMAGES_DIR}`);
    return downloaded;
}

// ‚îÄ‚îÄ Step 2: Generate devotional ambient audio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function generateBackgroundMusic() {
    const musicPath = path.join(MUSIC_DIR, 'om-devotional-ambient.aac');
    if (fs.existsSync(musicPath)) {
        console.log(`\nüéµ  Reusing existing audio: ${musicPath}`);
        return musicPath;
    }

    console.log('\nüéµ  Generating devotional ambient background audio (432 Hz)‚Ä¶');

    // Blend of harmonics rooted at 432 Hz ‚Äî peaceful and devotional in character
    const overtones = [
        '0.25*sin(2*PI*432*t)',   // A4 root (432 Hz)
        '0.15*sin(2*PI*540*t)',   // C#5 major third
        '0.12*sin(2*PI*648*t)',   // E5 fifth
        '0.08*sin(2*PI*864*t)',   // A5 octave
        '0.05*sin(2*PI*1080*t)',  // C#6 higher overtone
        '0.04*sin(2*PI*216*t)',   // A3 sub-octave
    ].join('+');

    runFFmpeg([
        '-y', '-f', 'lavfi',
        '-i', `aevalsrc=${overtones}:s=44100:c=stereo`,
        '-t', String(VIDEO_DURATION_SECS),
        '-c:a', 'aac', '-b:a', '128k',
        musicPath,
    ]);

    console.log(`  ‚úÖ  Background audio ready: ${musicPath}`);
    return musicPath;
}

// ‚îÄ‚îÄ Step 3: Build the 15-minute video ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function buildVideo(imagePaths, musicPath) {
    console.log('\nüé¨  Building 15-minute Radha-Krishna devotional video‚Ä¶');

    const tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), 'devotional-video-'));
    const segPaths = [];

    try {
        // Animate each image as a 60-second Ken-Burns segment
        for (let i = 0; i < imagePaths.length; i++) {
            const segPath = path.join(tmpDir, `seg-${String(i).padStart(3, '0')}.mp4`);
            const totalFrames = SECONDS_PER_IMAGE * FPS;
            // Alternate zoom-in / zoom-out for visual variety
            const zoomExpr = i % 2 === 0
                ? `min(zoom+${ZOOM_RATE},${MAX_ZOOM})`
                : `if(lte(zoom,1.0),${MAX_ZOOM},max(zoom-${ZOOM_RATE},1.0))`;
            const vf =
                `zoompan=z='${zoomExpr}':d=${totalFrames}` +
                `:x='iw/2-(iw/zoom/2)':y='ih/2-(ih/zoom/2)'` +
                `,scale=${TARGET_WIDTH}:${TARGET_HEIGHT},fps=${FPS}`;

            console.log(`  üñº  Animating image ${i + 1}/${imagePaths.length}: ${path.basename(imagePaths[i])}`);
            runFFmpeg([
                '-y', '-loop', '1', '-i', imagePaths[i],
                '-vf', vf,
                '-t', String(SECONDS_PER_IMAGE),
                '-pix_fmt', 'yuv420p', '-c:v', 'libx264', '-preset', 'fast',
                segPath,
            ]);
            segPaths.push(segPath);
        }

        // Concatenate all segments into a silent video
        const concatList = path.join(tmpDir, 'concat.txt');
        fs.writeFileSync(concatList, segPaths.map(p => `file '${p}'`).join('\n'));
        const silentVideo = path.join(tmpDir, 'silent.mp4');
        console.log('  üîó  Concatenating segments‚Ä¶');
        runFFmpeg(['-y', '-f', 'concat', '-safe', '0', '-i', concatList, '-c', 'copy', silentVideo]);

        // Mux silent video with background music
        console.log('  üéµ  Mixing audio‚Ä¶');
        fs.mkdirSync(OUTPUT_DIR, { recursive: true });
        runFFmpeg([
            '-y', '-i', silentVideo, '-i', musicPath,
            '-c:v', 'copy', '-c:a', 'aac', '-shortest',
            OUTPUT_FILE,
        ]);

    } finally {
        fs.rmSync(tmpDir, { recursive: true, force: true });
    }

    const { size } = fs.statSync(OUTPUT_FILE);
    console.log(`\n‚úÖ  Video saved: ${OUTPUT_FILE} (${(size / 1024 / 1024).toFixed(1)} MB)`);
    return OUTPUT_FILE;
}

// ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function main() {
    console.log('üôè  Radha-Krishna Devotional Video Generator');
    console.log('==============================================');
    console.log(`Theme    : ${THEME}`);
    console.log(`Subject  : ${GOD_NAME}`);
    console.log(`Duration : ${VIDEO_DURATION_SECS / 60} minutes`);
    console.log(`Images   : ${NUM_IMAGES} (${SECONDS_PER_IMAGE}s each)\n`);

    // Ensure all output directories exist up front
    for (const dir of [IMAGES_DIR, MUSIC_DIR, OUTPUT_DIR]) {
        fs.mkdirSync(dir, { recursive: true });
    }

    const imagePaths = await downloadWikimediaImages();
    const musicPath = await generateBackgroundMusic();
    await buildVideo(imagePaths, musicPath);

    console.log('\nüôè  Generation complete!');
    console.log(`üìÅ  Assets : ${BASE_ASSETS}`);
    console.log(`üé•  Video  : ${OUTPUT_FILE}`);
}

main().catch((err) => {
    console.error('\n‚ùå  Error:', err.message);
    process.exit(1);
});
