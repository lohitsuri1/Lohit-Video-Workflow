name: Generate Devotional Video (Python Pipeline)

# Generates a high-quality 1080p devotional video using the Python pipeline:
#   1. download_assets.py â€“ fetches a public-domain Radha-Krishna image
#      (Wikimedia Commons) and devotional audio (Internet Archive).
#      Falls back to ffmpeg-synthesized assets if network sources are unavailable.
#   2. pipeline.py â€“ combines image + audio into output/final_video.mp4
#      (1920Ã—1080, libx264 / AAC 192k, yuv420p).
#
# The finished video is uploaded as a GitHub Actions artifact and can be
# downloaded from Actions â†’ workflow run â†’ Artifacts.

on:
  workflow_dispatch:

jobs:
  generate-video:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: pip install -r requirements-pipeline.txt

      - name: Download assets (with ffmpeg fallback)
        run: |
          echo "=== Downloading Devotional Assets ==="
          if python download_assets.py; then
            echo "ASSET_SOURCE=network" >> "$GITHUB_ENV"
            echo "âœ…  Real devotional assets downloaded from internet sources"
          else
            echo "âš ï¸  Network download failed â€“ generating synthetic placeholder assets with FFmpeg"
            python download_assets.py --synthetic
            echo "ASSET_SOURCE=synthetic" >> "$GITHUB_ENV"
            echo "â„¹ï¸   Synthetic assets: saffron placeholder image + 432 Hz ambient audio"
          fi

      - name: Generate video
        run: python pipeline.py

      - name: Show video metadata
        run: |
          echo "=== Output Video Info ==="
          ffprobe -v quiet -show_streams -of default=noprint_wrappers=1 output/final_video.mp4 \
            | grep -E "^(codec_name|width|height|duration|bit_rate|sample_rate)=" || \
            ffmpeg -i output/final_video.mp4 2>&1 | grep -E "Duration|Stream"
          ls -lh output/final_video.mp4
          echo ""
          echo "=== Auto Quality Enhancements Applied ==="
          echo "  ğŸ¨  Warm golden colour grade (saturation +20%, reds +8%, blues -8%, brightness +3%)"
          echo "  ğŸ”  Gentle sharpening (unsharp 5Ã—5 luma mask)"
          echo "  ğŸŒ…  2-second fade-in and fade-out"
          echo "  ğŸ¬  libx264 CRF 20 | AAC 192k | yuv420p"
          if [ "${ASSET_SOURCE}" = "network" ]; then
            echo "  ğŸ“·  Image source: Wikimedia Commons (public-domain Radha-Krishna painting)"
            echo "  ğŸµ  Audio source: Internet Archive (public-domain devotional music)"
          else
            echo "  ğŸ“·  Image source: FFmpeg-generated placeholder (saffron 1920Ã—1080)"
            echo "  ğŸµ  Audio source: FFmpeg-synthesized 432 Hz harmonic ambient tone"
          fi

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-video
          path: output/final_video.mp4
          if-no-files-found: error
          retention-days: 14
